<!DOCTYPE html>
<html>
  <head>
  <title></title>
  
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no;" />
	<meta charset="utf-8">
    
    <link rel="stylesheet" href="css/jquerymobile/jqm.theme.css" type="text/css"/>
    <link rel="stylesheet" href="css/portal.css" type="text/css"/>
    
	<!-- Include all required JS libraries -->
	<script type="text/javascript" charset="utf-8" src="lib/external/cordova.js"></script>
    <script type="text/javascript" charset="utf-8" src="lib/external/jquery-1.6.1.js"></script>
    <script type="text/javascript">
        $(document).bind("mobileinit", function(){
            $.extend(  $.mobile , {
              ajaxEnabled: false,
              ajaxFormsEnabled: false
            });
         });
    </script>
    <script type="text/javascript" charset="utf-8" src="lib/external/jquery.mobile-1.0rc1.js"></script>
    <script type="text/javascript" charset="utf-8" src="lib/external/jquery-ui-1.8.13.js"></script>
    <script type="text/javascript" charset="utf-8" src="lib/external/fluid-all-1.4.0.js"></script>
    <script type="text/javascript" charset="utf-8" src="lib/external/gibberishAES.js"></script>
    
    <!--  Include uMobile libraries and configuration -->
    <script type="text/javascript" charset="utf-8" src="config.js"></script>
    <script type="text/javascript" charset="utf-8" src="lib/umobile/authentication.js"></script>
    <script type="text/javascript" charset="utf-8" src="lib/umobile/home.js"></script>

    <script type="text/javascript">
        var appstate, loginFn;
        appstate = {};
    
        var pages = {
            home: "#home",
            module: "#module",
            prefs: "#prefs"
        };
        
        var homeView;

        /**
         * Display a remote uMobile module.
         */
        var showModule = function (module) {
            
            // construct the URL for the selected module
            var moduleUrl = config.uMobileServerUrl + module.url;
            console.log("Displaying module " + module.fname + " with URL " + moduleUrl);

            // update the module page to contain the title and text for the
            // selected module
            $(".module-page-title").text(module.title);
            $("iframe").attr("src", moduleUrl);
            
            // transition to the module page
            $.mobile.changePage(pages.module, { transition: "none" });
        };
        
        /**
         * Update the home screen upon session establishment.
         */
        var updateHomeScreen = function (data) {
            console.log("Retrieved layout successfully. Rendering home screen");
            appstate.user = data.user;
            appstate.authenticated = data.user !== 'guest';
            if (appstate.authenticated) {
                $(".umobile-auth-invitation").hide();
            } else {
                $(".umobile-auth-invitation").show();
            }
            
            // construct a flat list of modules from the uMobile server response
            var modules = [];
            $(data.layout.folders).each(function (idx, folder) {
                $(folder.portlets).each(function (idx, portlet) {
                    portlet.iconUrl = config.nativeIcons[portlet.fname] || config.uPortalServerUrl + portlet.iconUrl;
                    if (config.nativeIcons[portlet.fname]) {
                        portlet.iconUrl = 'icons/' + config.nativeIcons[portlet.fname];
                    } else {
                        portlet.iconUrl = config.uPortalServerUrl + portlet.iconUrl;
                    }
                    portlet.itemCountClass = "up-new-item-count-" + portlet.newItemCount;
                    modules.push(portlet);
                });
            });

            // render the home screen view
            if (!homeView) {
                homeView = umobile.views.AppHomeView($(".module-list"), { model: { modules: modules } });
                $(".module-list").show();
            } else {
                homeView.update({ modules: modules });
            }
            $.mobile.hidePageLoadingMsg();
        };
        
        var displayLoginError =  function (jqXHR, textStatus, errorThrown) {
            $.mobile.hidePageLoadingMsg();
            navigator.notification.alert("Login failed");
        };
        
        /**
         * Update credentials upon preferences form submission.
         */
        var updateCredentials = function () {
            var username, password, credentials;

            $.mobile.showPageLoadingMsg("a", "Logging in");

            console.log("Updating user credentials");
            username = this.username.value;
            password = this.password.value;
            credentials = { username: username, password: password };
            
            // store the new credentials
            umobile.auth.storeCredentials(credentials);
            
            if (!(credentials.username && credentials.password)) {
                credentials = null;
            }
            
            // attempt to login
            umobile.auth.switchuser(
                credentials, 
                function (data) {
                    updateHomeScreen(data);
                    $.mobile.changePage(pages.home, { transition: "none" });
                },
                displayLoginError
            );            
        };

        
        function onBodyLoad () {
            document.addEventListener("deviceready", onDeviceReady, false);
            $.mobile.showPageLoadingMsg("a", "Loading modules");
        };
        
    	function onDeviceReady () {
    	    var credentials;

    	    // get credentials and login function
    	    credentials = umobile.auth.retrieveCredentials();
    	    if (credentials) {
  	            $(".umobile-auth-form input[name=username]").val(credentials.username);
    	    }
    	    loginFn = window["umobile"]["auth"][config.loginFn];

    	    // establish a sesison and update the home screen
            loginFn(credentials, updateHomeScreen, displayLoginError);
            
    	    // set handler for credentials update
    	    $(".umobile-auth-form").submit(updateCredentials);
    	    
    	    $(".logout-button").click(function () {
    	        $(".umobile-auth-form input[name=username]").val("");
                $(".umobile-auth-form input[name=password]").val("");
                $(".umobile-auth-form").submit();
    	    });
    	    
        };
    
    </script>
  </head>
  <body onload="onBodyLoad()" class="up fl-theme-iphone dashboard-grid">
  
      <!--  Main app home page.  Offers links to uMobile modules -->
      <div class="portal dashboard" data-role="page" id="home">
      
          <!-- Home screen titlebar -->
          <div data-role="header" data-backbtn="false" class="titlebar portlet-wrapper-titlebar">
              <h1 class="title">uMobile</h1>
              <a href="#prefs" class="ui-btn-right" data-transition="none" data-icon="gear">
                  <span>Prefs</span>
              </a>
          </div>
          
          <!-- Module links -->
          <div data-role="content" class="portlet-content">
          
              <div class="portal-nav module-list" style="display:none">
                  <div class="portlet module-item">
                      <a class="module-link" href="javascript:;" title="To view {@name}">
                          <span class="badge new-item">0</span>
                          <span class="icon"><img class="portlet-icon module-icon" src="" alt=""/></span>
                          <span class="title module-title">Portlet</span>
                      </a>
                  </div>
              </div>
              
          </div>
          
          <div data-role="footer" class="umobile-auth-invitation">
              <a href="#prefs" data-transition="none">You are using uMobile as a guest user.  Click here to log in!</a>
          </div>
      </div>

      <!--  Module IFrame. Displays WebView-based content -->
      <div class="portal focused" data-role="page" id="module">

          <!-- Module titlebar -->
          <div class="titlebar portlet-wrapper-titlebar" data-role="header" data-position="inline">
              <a href="#home" data-icon="home" data-direction="reverse" data-transition="none">Home</a>
              <h1 class="title module-page-title">Portlet</h1>
          </div>
          
          <!-- Module content  -->
          <iframe style="width: 100%; height:500px; border: none; padding: 0; margin: 0">
          </iframe>
          
      </div>
      
      <!--  Preferences page.  Offers authentication and other options. -->
      <div class="portal focused" data-role="page" id="prefs">

          <!-- Module titlebar -->
          <div class="titlebar portlet-wrapper-titlebar" data-role="header" data-position="inline">
              <a href="#home" data-icon="home" data-direction="reverse" data-transition="none">Home</a>
              <h1 class="title module-page-title">Preferences</h1>
          </div>
          
          <div class="portlet">
              <div class="portlet-content" data-role="content">
                  <form class="umobile-auth-form" action="javascript:;">
                      <label for="usernameInput">Username:</label>
                      <input id="usernameInput" name="username" type="text"/>
                      
                      <label for="passwordInput">Password:</label>
                      <input id="passwordInput" name="password" type="password"/>
                      
                      <input type="submit" name="update" value="Update"/>
                      <input type="button" class="logout-button" name="logout" value="Log out"/>
                   </form>
              </div>
          </div>
          
      </div>
      
  </body>
</html>
